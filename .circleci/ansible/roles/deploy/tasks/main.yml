---
- name: create web directory
  # become: yes
  file:
    path: ~/backend_content
    state: directory

# - name: extract zipped backend content from local
#   unarchive:
#     src: ~/artifact.tar.gz
#     dest: ~/backend_content

# - name: create web directory2
#   file:
#     path: ~/backend_content2
#     state: directory

- name: extract zipped backend content
  # become: yes
  shell: |
    tar xvzf /tmp/artifact.tar.gz --directory ~/backend_content
  register: test_output

- debug:
    var: test_output

- name: start udapeople backend app
  # become: yes
  shell: |
    cd ~/backend_content
    npm install
    pm2 stop default
    pm2 start npm -- start
  environment:
    TYPEORM_CONNECTION: "{{ lookup('env', 'TYPEORM_CONNECTION')}}"  
    TYPEORM_ENTITIES: "{{ lookup('env', 'TYPEORM_ENTITIES')}}"
    TYPEORM_HOST: "{{ lookup('env', 'TYPEORM_HOST')}}"
    TYPEORM_PORT: 5432
    TYPEORM_USERNAME: "{{ lookup('env', 'TYPEORM_USERNAME')}}"
    TYPEORM_PASSWORD: "{{ lookup('env', 'TYPEORM_PASSWORD')}}"
    TYPEORM_DATABASE: "{{ lookup('env', 'TYPEORM_DATABASE')}}"
    TYPEORM_MIGRATIONS: "{{ lookup('env', 'TYPEORM_MIGRATIONS')}}"
    TYPEORM_MIGRATIONS_DIR: "{{ lookup('env', 'TYPEORM_MIGRATIONS_DIR')}}"

- name: check vars
  shell: |
    echo {$TYPEORM_CONNECTION $TYPEORM_ENTITIES $TYPEORM_HOST $TYPEORM_PORT $TYPEORM_USERNAME}
  register: set_vars

- debug: var=test_output


